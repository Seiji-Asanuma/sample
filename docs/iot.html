<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>IoTセンサーデモ</title>
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
</head>

<body>
    <div id="app">
        <div class="list-group">
            <a href="#" class="list-group-item list-group-item-action active">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">デバイスID</h5>
                </div>
            </a>
            <a href="#" class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">{{deviceId}}</h5>
                </div>
                <p class="mb-1">説明</p>
                <small class="text-muted">何か説明を入れる.</small>
            </a>
        </div>


        <div class="list-group">
            <a href="#" class="list-group-item list-group-item-action active">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">センサー接続状況</h5>
                </div>
            </a>
            <a href="#" class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">
                        <div v-if="showCounter">
                            取得中
                        </div>
                        <div v-else>
                            未取得
                        </div>
                    </h5>
                </div>
                <p class="mb-1">加速度センサ</p>
                <small class="text-muted">何か説明を入れる.</small>
            </a>
            <a href="#" class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">
                        <div v-if="showCounter">
                            取得中　接続残り時間　{{counterMax-counter}} 秒
                        </div>
                        <div v-else>
                            未接続
                        </div>
                    </h5>
                </div>
                <p class="mb-1">MQTTサーバ接続</p>
                <small class="text-muted">何か説明を入れる.</small>
            </a>
        </div>
        <div class="list-group">
            <a href="#" class="list-group-item list-group-item-action active">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">加速度センサー情報</h5>
                </div>
            </a>
            <a href="#" class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">{{accelerationIncludingGravity.x}}</h5>
                </div>
                <p class="mb-1">X方向</p>
            </a>
            <a href="#" class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">{{accelerationIncludingGravity.y}}</h5>
                </div>
                <p class="mb-1">y方向</p>
            </a>
            <a href="#" class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">{{accelerationIncludingGravity.z}}</h5>
                </div>
                <p class="mb-1">z方向</p>
            </a>
        </div>
        <div class="card">
            <div class="card-header">
                注意
            </div>
            <div class="card-body">
                <blockquote class="blockquote mb-0">
                    <div>iPhone場合「加速度センサー情報をMQTTサーバに送信」を押すと、</div>
                    <div>「動作と方向」へのアクセスに関する確認ダイアログが表示されます。</div>
                    <div>ダイアログが表示されたら許可してください。</div>
                    <footer class="blockquote-footer">何か書く</footer>
                </blockquote>
            </div>
        </div>
        <div class="text-right">
            <button type="button" @click="deviceMotionRequestAuthenticate" class="btn btn-warning btn-lg mt-2 mr-2">加速度センサー情報をMQTTサーバに送信</button>
            <button type="button" @click="deviceMotionRequestDelete" class="btn btn-secondary btn-lg mt-2 mr-2">送信を中止</button>
        </div>
    </div>
  <script src="https://cdn.jsdelivr.net/npm/babel-standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/babel-polyfill/dist/polyfill.min.js">   
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

    <script src="./mqttws31.js" type="text/javascript"></script>
    <script src="https://unpkg.com/vue@3.0.2/dist/vue.global.js"></script>
    <script>
        let client;
        Vue.createApp({
            data() {
                return {
                    accelerationIncludingGravity: {
                        "x": "0.0",
                        "y": "0.0",
                        "z": "0.0"
                    },
                    counter: 0,
                    counterMax: 30,
                    showCounter: false,

                    isConnect: false,
                    loadingIot: false,
                    deviceId:"",
                    topic: "iot-2/evt/status/fmt/json",
                    serverURL: "quickstart.messaging.internetofthings.ibmcloud.com",
                    serverPort: 443,
                    deviceType: "MyDevice"

                }
            },
            methods: {
                /*
                 * イベントハンドラ devicemotion がコールする処理
                 */
                showEvent() {
                    if (!event.accelerationIncludingGravity) {
                        this.showErrorDialog('[003]');
                        return;
                    }
                    this.accelerationIncludingGravity = event.accelerationIncludingGravity;
                    this.publish();

                },

                /**
                 * - MQTTサーバ接続
                 * - スマホの加速度情報を,JavascriptのaccelerationIncludingGravityから取得するようにリスナーを定義
                 */
                deviceMotionRequestAuthenticate() {

                    //ループカウンターを初期化
                    this.counter = 0;
                    this.showCounter = true;

                    //MQTT接続
                    this.connectClient();

                    // androidの場合は、requestPermission不要
                    if (navigator.userAgent.indexOf('Android') > 0) {
                        window.addEventListener("devicemotion", this.showEvent);

                        // iPhone,iPadの場合は、requestPermissionが必要
                    } else if (navigator.userAgent.indexOf('iPhone') > 0 || navigator.userAgent.indexOf('iPad') > 0) {
                        //　requestPermissionが存在する = iPhone or iPad
                        if (DeviceMotionEvent.requestPermission) {
                            DeviceMotionEvent.requestPermission()
                                .then(permissionState => {
                                    if (permissionState === 'granted') {
                                        window.addEventListener("devicemotion", this.showEvent);
                                    } else {
                                        this.showErrorDialog("[005]")
                                    }
                                })
                                .catch(console.error);
                        } else {
                            this.showErrorDialog('[001]')
                        }

                    } else {
                        this.showErrorDialog("[002]")
                    }
                },
                deviceMotionRequestDelete() {
                    window.removeEventListener("devicemotion", this.showEvent);
                    this.showCounter = false;
                },
                /**
                 * ibmcloud IoTに接続するためのクライアントIDを作成する
                 */
                getDeviceId() {
                    var did = '';
                    var hx = '0123456789abcdef';
                    for (var i = 0; i < 12; i++) {
                        var n = Math.floor(Math.random() * 16);
                        if (n == 16) {
                            n = 15;
                        }
                        c = hx.charAt(n);
                        did += c;
                    }
                    this.deviceId = did;
                },
                /**
                 * Connect to IBM MQTT
                 */
                connectClient() {
                    this.loadingIot = true;
                    var clientID = "d:quickstart:" + this.deviceType + ":" + this.deviceId;
                    client = new Messaging.Client(this.serverURL, this.serverPort, clientID);
                    client.onConnectionLost = this.onConnectionLost;
                    client.connect({
                        onSuccess: this.onSuccess,
                        useSSL: true
                    });
                },

                onSuccess() {
                    console.log("onSuccess");
                    this.isConnect = true;
                    this.loadingIot = false;
                },
                onConnectionLost() {
                    console.log("lost");
                    this.isConnect = false;
                },
                /** publisher */
                publish() {
                    var message = new Messaging.Message(JSON.stringify({
                        "d": {
                            "name": this.deviceId,
                            "x": this.accelerationIncludingGravity.x,
                            "y": this.accelerationIncludingGravity.y,
                            "z": this.accelerationIncludingGravity.z
                        }
                    }));
                    message.destinationName = this.topic;
                    client.send(message);
                },
                showErrorDialog(msg) {
                    alert(msg);
                    this.showCounter = false;
                },
            },
            beforeUnmount() {
                this.deviceMotionRequestDelete();
            },
            /** 1秒おきにカウンターをインクリメントする(counterMax以上は回らないようにするDDos対策) */
            mounted() {
                this.getDeviceId();
                setInterval(() => {
                    this.counter++
                }, 1000);
            },
            watch: {
                counter(val) {
                    //カウンターが最大値まで行ったらイベントを削除する。
                    if (val > this.counterMax) {
                        this.counter = 0;
                        this.showCounter = false;
                        this.deviceMotionRequestDelete();
                    }
                }
            }

        }).mount('#app');

    </script>

    <style>
        html {
            font-size: 1.5em;
        }

    </style>

</body>

</html>
